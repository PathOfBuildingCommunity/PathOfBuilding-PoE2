-- Path of Building
--
-- Other active skills
-- Skill data (c) Grinding Gear Games
--
local skills, mod, flag, skill = ...

#from tree
#skill AcidicConcoctionPlayer
#set AcidicConcoctionPlayer
#flags attack projectile unarmed area
#mods
#set AcidicConcoctionPoisonBurstPlayer
#flags attack area
statMap = {
	["poisonous_concoction_area_of_effect_+%_final_per_active_poison_consumed"] = {
		mod("AreaOfEffect", "MORE", nil, 0, 0, { type = "Multiplier", actor = "enemy", var = "PoisonStacks" }),
	},
	["active_skill_base_secondary_area_of_effect_radius"] = {
		skill("radius", nil),
	},
},
#mods
#skillEnd

#from tree
#minionList AncestralSpiritTurtle AncestralSpiritHulk AncestralSpiritCaster AncestralSpiritWarhorn
#skill AncestralSpiritsPlayer
#set AncestralSpiritsPlayer
#flags spell minion
statMap = {
	["minion_1%_damage_+%_per_X_player_strength"] = {
		mod("MinionModifier", "LIST", { mod = mod("Damage", "INC", nil, 0, 0, { type = "PerStat", stat = "Str", actor = "parent" }) }),
	},
	["minion_1%_attack_speed_+%_per_X_player_dexterity"] = {
		mod("MinionModifier", "LIST", { mod = mod("Speed", "INC", nil, ModFlag.Attack, 0, { type = "PerStat", stat = "Dex", actor = "parent", div = 3 }) }),
		div = 3,
	},
},
#mods
#skillEnd

#from tree
#skill BleedingConcoctionPlayer
#set BleedingConcoctionPlayer
#flags attack projectile unarmed area
#mods
#skillEnd

#from tree
#skill BloodBoilPlayer
#set BloodBoilPlayer
#flags
#mods
#skillEnd

#from item
#skill MeleeBowPlayer
#set MeleeBowPlayer
#flags attack projectile
#mods
#skillEnd

#from item
#skill ExplodingPoisonToadPlayer
#set ExplodingPoisonToadPlayer
#flags area attack
#mods
#skillEnd

#from tree
#skill MetaDeadeyeMarksPlayer
#set MetaDeadeyeMarksPlayer
#flags
#mods
#skillEnd

#from tree
#skill SupportMetaDeadeyeMarksPlayer
#set SupportMetaDeadeyeMarksPlayer
#mods
#skillEnd

#from item
#skill MetaCastOnCharmUsePlayer
#set MetaCastOnCharmUsePlayer
#flags
#mods
#skillEnd

#from item
#skill SupportMetaCastOnCharmUsePlayer
#set SupportMetaCastOnCharmUsePlayer
#mods
#skillEnd

#from item
#skill MeleeCrossbowPlayer
#set MeleeCrossbowPlayer
#flags attack area projectile
#mods
#skillEnd

#from item
#skill UnloadAmmoPlayer
#set UnloadAmmoPlayer
#flags
#mods
#skillEnd

#from tree
#skill DemonFormPlayer
#set DemonFormPlayer
#flags
#mods
#skillEnd

#from tree
#skill ElementalExpressionTriggeredPlayer
#set ElementalExpressionTriggeredPlayer
#flags
#mods
#set ElementalExpressionFirePlayer
#flags spell area
#mods
#set ElementalExpressionColdPlayer
#flags spell projectile
#mods
#set ElementalExpressionLightningPlayer
#flags spell chaining
#mods
#skillEnd

#from tree
#skill ElementalStormPlayer
#set ElementalStormPlayer
#flags area duration
statMap = {
	["tornado_base_damage_interval_ms"] = {
		skill("hitTimeOverride", nil),
		div = 1000,
	},
},
#mods
#set ElementalStormFirePlayer
#flags spell area duration
statMap = {
	["tornado_base_damage_interval_ms"] = {
		skill("hitTimeOverride", nil),
		div = 1000,
	},
},
#mods
#set ElementalStormLightningPlayer
#flags spell area duration
statMap = {
	["tornado_base_damage_interval_ms"] = {
		skill("hitTimeOverride", nil),
		div = 1000,
	},
},
#mods
#set ElementalStormColdPlayer
#flags spell area duration
statMap = {
	["tornado_base_damage_interval_ms"] = {
		skill("hitTimeOverride", nil),
		div = 1000,
	},
},
#mods
#skillEnd

#from tree
#skill AmazonTriggerElementalSurgePlayer
#set AmazonTriggerColdSurgePlayer
#flags attack area
#mods
#set AmazonTriggerFireSurgePlayer
#flags attack area
#mods
#set AmazonTriggerLightningSurgePlayer
#flags attack area
#mods
#skillEnd

#from tree
#skill EncaseInJadePlayer
#set EncaseInJadePlayer
#flags duration
#mods
#skillEnd

#from tree
#skill ExplosiveConcoctionPlayer
#set ExplosiveConcoctionPlayer
#flags attack projectile duration unarmed area
statMap = {
	["flask_throw_fire_exposure_ms"] = {
		mod("FireExposureChance", "BASE", nil),
		value = 100,
	},
},
#mods
#skillEnd

#from tree
#skill MetaCastFireSpellOnHitPlayer
#set MetaCastFireSpellOnHitPlayer
#flags
#mods
#skillEnd

#from tree
#skill SupportMetaCastFireSpellOnHitPlayer
#set SupportMetaCastFireSpellOnHitPlayer
#flags
#mods
#skillEnd

#from tree
#skill FulminatingConcoctionPlayer
#set FulminatingConcoctionPlayer
#flags attack projectile duration unarmed area
statMap = {
	["flask_throw_lightning_exposure_ms"] = {
		mod("LightningExposureChance", "BASE", nil),
		value = 100,
	},
},
#mods
#skillEnd

#from item
#skill FuturePastPlayer
#set FuturePastPlayer
#flags
#mods
#skillEnd

#from tree
#skill InevitableAgonyPlayer
#set InevitableAgonyPlayer
#flags
#mods
#skillEnd

#from tree
#skill IntoTheBreachPlayer
#set IntoTheBreachPlayer
#flags
#mods
#skillEnd

#from tree
#skill LifeRemnantsPlayer
#set LifeRemnantsPlayer
#flags
#mods
#skillEnd

#from item
#skill Melee1HMacePlayer
#set Melee1HMacePlayer
#flags attack area melee
#mods
#skillEnd

#from item
#skill Melee2HMacePlayer
#set Melee2HMacePlayer
#flags attack area melee
#mods
#skillEnd

#from item
#skill MeleeMaceMacePlayer
#set MeleeMaceMacePlayer
#flags attack area melee
#mods
#skillEnd

#from tree
#minionList ManifestWeapon
#skill ManifestWeaponPlayer
minionHasItemSet = true,
minionUses = {
	["Weapon 1"] = true,
},
#set ManifestWeaponPlayer
#flags spell minion duration
statMap = {
	["minion_1%_damage_+%_per_X_player_strength"] = {
		mod("MinionModifier", "LIST", { mod = mod("Damage", "INC", nil, 0, 0, { type = "PerStat", stat = "Str", actor = "parent" }) }),
	},
	["minion_1%_attack_speed_+%_per_X_player_dexterity"] = {
		mod("MinionModifier", "LIST", { mod = mod("Speed", "INC", nil, ModFlag.Attack, 0, { type = "PerStat", stat = "Dex", actor = "parent", div = 3 }) }),
		div = 3,
	},
},
#mods
#skillEnd

#from tree
#skill MeditatePlayer
#set MeditatePlayer
#flags
#mods
#skillEnd

#from tree
#skill ParryPlayer
#set ParryPlayer
#flags attack melee duration shieldAttack
statMap = {
	["base_parry_buff_damage_taken_+%_final_to_apply"] = {
		mod("DamageTaken", "MORE", nil, ModFlag.Attack, 0, { type = "GlobalEffect", effectType = "Debuff", effectName = "Parry" }, { type = "Condition", var = "ParryActive" }),
	},
},
#mods
#skillEnd

#from item
#skill PinnacleOfPowerPlayer
#set PinnacleOfPowerPlayer
#flags buff duration
#mods
#skillEnd

#noGem
#skill MeleeUnarmedPlayer
#set MeleeUnarmedPlayer
#flags attack area melee
#mods
#skillEnd

#from item
#skill MeleeQuarterstaffPlayer
#set MeleeQuarterstaffPlayer
#flags attack melee area
#mods
#skillEnd

#from item
#skill ShieldBlockPlayer
#set ShieldBlockPlayer
#flags attack area shieldAttack melee
#mods
#skillEnd

#from tree
#skill RitualSacrificePlayer
#set RitualSacrificePlayer
#flags attack area
#mods
#skillEnd

#from tree
#skill ShatteringConcoctionPlayer
#set ShatteringConcoctionPlayer
#flags attack projectile duration unarmed area
statMap = {
	["flask_throw_cold_exposure_ms"] = {
		mod("ColdExposureChance", "BASE", nil),
		value = 100,
	},
},
#mods
#skillEnd

#from tree
#skill SorceryWardPlayer
#set SorceryWardPlayer
#flags
#mods
#skillEnd

#from item
#skill MeleeSpearOffHandPlayer
#set MeleeSpearOffHandPlayer
#flags attack melee area
#mods
#skillEnd

#from item
#skill MeleeSpearPlayer
#set MeleeSpearPlayer
#flags attack melee area
#mods
#skillEnd

#from item
#skill SpearThrowPlayer
#set SpearThrowPlayer
#flags attack projectile
#mods
#set SpearThrowFrenzyChargePlayer
#flags attack projectile area
#mods
#skillEnd

#from tree
#minionList SummonedHellhound
#skill SummonInfernalHoundPlayer
#set SummonInfernalHoundPlayer
#flags spell minion permanentMinion
#mods
#skillEnd

#from tree
#minionList TacticianMinion
#skill SupportingFirePlayer
#set SupportingFirePlayer
#flags minion permanentMinion
statMap = {
	["minion_1%_damage_+%_per_X_player_strength"] = {
		mod("MinionModifier", "LIST", { mod = mod("Damage", "INC", nil, 0, 0, { type = "PerStat", stat = "Str", actor = "parent" }) }),
	},
	["minion_1%_area_of_effect_+%_per_X_player_dexterity"] = {
		mod("MinionModifier", "LIST", { mod = mod("AreaOfEffect", "INC", nil, 0, 0, { type = "PerStat", stat = "Dex", actor = "parent", div = 3 }) }),
		div = 3,
	},
},
#mods
#skillEnd

#from tree
#skill TemperWeaponPlayer
#set TemperWeaponPlayer
#flags
#mods
#skillEnd

#from tree
#skill TemperWeaponCombustionPlayer
#set TemperWeaponCombustionPlayer
#flags attack area
#mods
#skillEnd

#from tree
#skill TemporalRiftPlayer
#set TemporalRiftPlayer
#flags
#mods
#skillEnd

#from tree
#skill TimeFreezePlayer
#set TimeFreezePlayer
#flags area duration
#mods
#skillEnd

#from tree
#skill TimeSnapPlayer
#set TimeSnapPlayer
#flags
#mods
#skillEnd

#from tree
#skill UnboundAvatarPlayer
#set UnboundAvatarPlayer
#flags
#mods
#skillEnd

#from tree
#skill VoidIllusionPlayer
#set VoidIllusionPlayer
#flags
#mods
#skillEnd

#from tree
#skill VoidIllusionSpawnPlayer Void Illusion
#set VoidIllusionSpawnPlayer
#flags attack
#mods
#skillEnd

skills["EnemyExplode"] = {
	name = "On Kill Monster Explosion",
	hidden = true,
	color = 4,
	skillTypes = { [SkillType.Damage] = true, [SkillType.Area] = true, },
	castTime = 0,
	levels = {
		[1] = { damageEffectiveness = 0, baseMultiplier = 1, levelRequirement = 1, }
	},
	preDamageFunc = function(activeSkill, output)
		output.ExplodeChance = 0
		local statSet = activeSkill.activeEffect.statSet or activeSkill.activeEffect.statSetCalcs
		if statSet.index ~= 3 then
			local allExplodeMods = activeSkill.skillModList:Tabulate("LIST", activeSkill.skillCfg, "ExplodeMod")
			for _, explodeMod in ipairs(allExplodeMods) do
				local activeEffectSource = activeSkill.activeEffect.srcInstance.explodeSource.modSource or "Tree:"..activeSkill.activeEffect.srcInstance.explodeSource.id
				if explodeMod.mod.source == activeEffectSource then
					local explodeMod = explodeMod.value
					if explodeMod.type == "RandomElement" then
						activeSkill.skillData["FireEffectiveExplodePercentage"] = explodeMod.amount / 3
						activeSkill.skillData["ColdEffectiveExplodePercentage"] = explodeMod.amount / 3
						activeSkill.skillData["LightningEffectiveExplodePercentage"] = explodeMod.amount / 3
					else
						activeSkill.skillData[explodeMod.type.."EffectiveExplodePercentage"] = explodeMod.amount
					end
					output.ExplodeChance = statSet.index == 2 and 1 or explodeMod.chance
				end
			end
		else
			local typeAmountChances = { }
			local explodeModList = activeSkill.skillModList:List(activeSkill.skillCfg, "ExplodeMod")
			for _, explodeMod in ipairs(explodeModList) do
				local amountChance = typeAmountChances[explodeMod.type] or { }
				amountChance[explodeMod.amount] = (amountChance[explodeMod.amount] or 0) + explodeMod.chance
				typeAmountChances[explodeMod.type] = amountChance
			end
			for type, amountChance in pairs(typeAmountChances) do
				local physExplodeChance = 0
				for amount, chance in pairs(amountChance) do
					local amountXChance = amount * chance
					if type == "RandomElement" then
						activeSkill.skillData["FireEffectiveExplodePercentage"] = (activeSkill.skillData["FireEffectiveExplodePercentage"] or 0) + amountXChance / 3
						activeSkill.skillData["ColdEffectiveExplodePercentage"] = (activeSkill.skillData["ColdEffectiveExplodePercentage"] or 0) + amountXChance / 3
						activeSkill.skillData["LightningEffectiveExplodePercentage"] = (activeSkill.skillData["LightningEffectiveExplodePercentage"] or 0) + amountXChance / 3
					else
						activeSkill.skillData[type.."EffectiveExplodePercentage"] = (activeSkill.skillData[type.."EffectiveExplodePercentage"] or 0) + amountXChance
					end
					if type == "Physical" then
						physExplodeChance = 1 - ((1 - physExplodeChance) * (1 - chance))
					end
					output.ExplodeChance = 1 - ((1 - output.ExplodeChance) * (1 - chance))
				end
				if type == "Physical" and physExplodeChance ~= 0 then
					activeSkill.skillModList:NewMod("CalcArmourAsThoughDealing", "MORE", 100 / math.min(physExplodeChance, 1) - 100)
				end
			end
		end
		output.ExplodeChance = math.min(output.ExplodeChance * 100, 100)
	end,
	statSets = {
		[1] = {
			label = "This Source Only",
			baseFlags = {
				area = true,
				monsterExplode = true,
			},
			baseMods = {
				skill("radius", 22),
				skill("showAverage", true),
				skill("corpseExplosionLifeMultiplier", 0),
				skill("explodeCorpse", true),
				skill("hitChanceIsExplodeChance", true),
			},
			stats = {
				"is_area_damage",
				"base_skill_show_average_damage_instead_of_dps",
				"display_skill_deals_secondary_damage",
				"damage_cannot_be_reflected",
				"skill_can_add_multiple_charges_per_action",
			},
			levels = {
				[1] = { },
			},
		},
		[2] = {
			label = "This Source Only, Ignoring Chance",
			baseFlags = {
				area = true,
				monsterExplode = true,
			},
			baseMods = {
				skill("radius", 22),
				skill("showAverage", true),
				skill("corpseExplosionLifeMultiplier", 0),
				skill("explodeCorpse", true),
			},
			stats = {
				"is_area_damage",
				"base_skill_show_average_damage_instead_of_dps",
				"display_skill_deals_secondary_damage",
				"damage_cannot_be_reflected",
				"skill_can_add_multiple_charges_per_action",
			},
			levels = {
				[1] = { },
			},
		},
		[3] = {
			label = "Average of All Sources",
			baseFlags = {
				area = true,
				monsterExplode = true,
			},
			baseMods = {
				skill("radius", 22),
				skill("showAverage", true),
				skill("corpseExplosionLifeMultiplier", 0),
				skill("explodeCorpse", true),
			},
			stats = {
				"is_area_damage",
				"base_skill_show_average_damage_instead_of_dps",
				"display_skill_deals_secondary_damage",
				"damage_cannot_be_reflected",
				"skill_can_add_multiple_charges_per_action",
			},
			levels = {
				[1] = { },
			},
		},
	}
}
